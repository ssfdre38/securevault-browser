name: Build SecureVault Browser - Windows

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-2022
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Install depot_tools
      shell: cmd
      run: |
        git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git
        set PATH=%CD%\depot_tools;%PATH%
        
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Configure gclient
      shell: cmd
      run: |
        set PATH=%CD%\depot_tools;%PATH%
        echo solutions = [ > .gclient
        echo   { >> .gclient
        echo     "name": "src", >> .gclient
        echo     "url": "https://chromium.googlesource.com/chromium/src.git", >> .gclient
        echo     "managed": False, >> .gclient
        echo     "custom_deps": {}, >> .gclient
        echo     "custom_vars": {}, >> .gclient
        echo   }, >> .gclient
        echo ] >> .gclient
        echo target_os = ["win"] >> .gclient
        
    - name: Fetch Chromium source
      shell: cmd
      run: |
        set PATH=%CD%\depot_tools;%PATH%
        set DEPOT_TOOLS_WIN_TOOLCHAIN=0
        fetch --nohooks --no-history chromium
        cd src
        git checkout -b securevault origin/main
        
    - name: Run gclient sync
      shell: cmd
      run: |
        set PATH=%CD%\depot_tools;%PATH%
        set DEPOT_TOOLS_WIN_TOOLCHAIN=0
        cd src
        gclient sync --no-history --shallow
        
    - name: Apply SecureVault patches
      shell: bash
      run: |
        cd src
        for patch in ../patches/*.patch; do
          if [ -f "$patch" ]; then
            git apply "$patch" || echo "Patch already applied: $patch"
          fi
        done
        
    - name: Configure build
      shell: cmd
      run: |
        set PATH=%CD%\depot_tools;%PATH%
        cd src
        mkdir out\SecureVault
        (
        echo is_debug = false
        echo is_official_build = true
        echo is_component_build = false
        echo symbol_level = 0
        echo chrome_pgo_phase = 0
        echo is_chrome_branded = false
        echo google_api_key = ""
        echo google_default_client_id = ""
        echo google_default_client_secret = ""
        echo enable_google_now = false
        echo enable_hangout_services_extension = false
        echo enable_remoting = false
        echo enable_nacl = false
        echo enable_crash_reporter = false
        echo enable_error_dialogs = false
        echo enable_mdns = false
        echo enable_service_discovery = false
        echo enable_wifi_bootstrapping = false
        echo enable_one_click_signin = false
        echo safe_browsing_mode = 0
        echo use_cups = false
        echo use_kerberos = false
        echo proprietary_codecs = true
        echo ffmpeg_branding = "Chrome"
        echo target_cpu = "x64"
        echo fieldtrial_testing_like_official_build = true
        echo enable_reporting = false
        echo enable_js_protobuf = false
        echo use_thin_lto = true
        echo thin_lto_enable_optimizations = true
        ) > out\SecureVault\args.gn
        gn gen out\SecureVault
        
    - name: Build SecureVault Browser
      shell: cmd
      run: |
        set PATH=%CD%\depot_tools;%PATH%
        cd src
        ninja -C out\SecureVault chrome
        
    - name: Package Windows binary
      shell: bash
      run: |
        cd src/out/SecureVault
        7z a ../../../securevault-browser-windows-x64.zip chrome.exe *.dll *.pak locales/ resources/
        
    - name: Upload Windows artifact
      uses: actions/upload-artifact@v4
      with:
        name: securevault-browser-windows-x64
        path: securevault-browser-windows-x64.zip
        retention-days: 30
